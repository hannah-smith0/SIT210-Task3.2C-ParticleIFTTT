//Constants
#define PUBLISH_DELAY 15000 //15 seconds delay between publishing to avoid sending too often

#define LIGHT_THRESHOLD 15 //The threshold for detecting sunlight


//Variables
int photoresistor = A0; // The readings from the light sensor

int lightLevelPrevious = -1;  //An int to describe the reading from the last loop

int lightLevelCurrent;  //An int to describe the reading from the current loop

int thresholdCrossed = -1;   //An int to send a message to the IFTTT


//Setup
void setup() 
{
    //Particle variables to be read by IFTTT
    Particle.variable("sunlightThreshold", &thresholdCrossed, INT);
    pinMode(photoresistor, INPUT);
}


//Loop
void loop() 
{
    //Gathers sensor data
    lightLevelCurrent = analogRead(photoresistor);
    
    //lightLevel = random(100,1000); //dummy value for testing purposes
    
    String lightString = String(lightLevelCurrent);  //string for sending to ThingSpeak
    
    //Publishes sensor data to ThingSpeak
    Particle.publish("sunlight", lightString, PRIVATE);
    
    //Checks if the light level has gone over the threshold
    //This stops the system from spamming. It only sends messages if there is a change in conditions
    if (lightLevelPrevious != -1 && lightLevelPrevious < LIGHT_THRESHOLD && lightLevelCurrent >= LIGHT_THRESHOLD)
    {
        //This will trigger the IFTTT to fire a "sunlight detected" event
        thresholdCrossed = 1;
    }
    if (lightLevelPrevious != -1 && lightLevelPrevious >= LIGHT_THRESHOLD && lightLevelCurrent < LIGHT_THRESHOLD)
    {
        //Fires the "sunlight stopped" trigger
        thresholdCrossed = 0;
    }
    
    //Sets the lightLevelPrevious value to the current value, ready for the next loop's comparison
    lightLevelPrevious = lightLevelCurrent;
    
    //sets threshold variable back to -1 to avoid refiring constantly
    thresholdCrossed = -1

    
    //Waits for the set delay time
    delay(PUBLISH_DELAY);

}
